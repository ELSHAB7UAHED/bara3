name: Build ESP32 Firmware

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SKETCH_NAME: your_project_name.ino  # ðŸ”§ ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø§Ø³Ù… Ù…Ù„Ù .ino Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
  ESP32_CORE_VERSION: 3.0.0  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø±

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        board: 
          - esp32:esp32:esp32
          # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø§Øª
          # - esp32:esp32:esp32s3
          # - esp32:esp32:esp32c3
    
    steps:
      # ðŸ§± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Arduino CLI
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 'latest'

      # ðŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ØªÙƒÙˆÙŠÙ† Arduino CLI
      - name: Configure Arduino CLI
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # ðŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³ ÙˆØªØ«Ø¨ÙŠØª Ù„ÙˆØ­Ø© ESP32
      - name: Update index and install ESP32 core
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}

      # ðŸ“š ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      - name: Install required libraries
        run: |
          # Ù…ÙƒØªØ¨Ø© ArduinoJson
          arduino-cli lib install "ArduinoJson@7.x"
          
          # Ø­Ø°Ù Ù…ÙƒØªØ¨Ø© Ticker Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶)
          rm -rf $HOME/Arduino/libraries/Ticker 2>/dev/null || true
          
          # ØªØ«Ø¨ÙŠØª ESPAsyncWebServer
          if [ ! -d "$HOME/Arduino/libraries/ESPAsyncWebServer" ]; then
            git clone --depth 1 https://github.com/me-no-dev/ESPAsyncWebServer.git \
              $HOME/Arduino/libraries/ESPAsyncWebServer
          fi
          
          # ØªØ«Ø¨ÙŠØª AsyncTCP
          if [ ! -d "$HOME/Arduino/libraries/AsyncTCP" ]; then
            git clone --depth 1 https://github.com/me-no-dev/AsyncTCP.git \
              $HOME/Arduino/libraries/AsyncTCP
          fi
          
          # ØªØ«Ø¨ÙŠØª WiFiManager
          if [ ! -d "$HOME/Arduino/libraries/WiFiManager" ]; then
            git clone --depth 1 --branch master https://github.com/tzapu/WiFiManager.git \
              $HOME/Arduino/libraries/WiFiManager
          fi

      # ðŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: Verify sketch file
        run: |
          if [ ! -f "${{ env.SKETCH_NAME }}" ]; then
            echo "âŒ Error: Sketch file '${{ env.SKETCH_NAME }}' not found!"
            echo "ðŸ“ Available files:"
            ls -la *.ino 2>/dev/null || echo "No .ino files found"
            exit 1
          fi
          echo "âœ… Found sketch: ${{ env.SKETCH_NAME }}"

      # ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø«Ø§Ø¨Øª
      - name: Compile firmware
        run: |
          mkdir -p build
          echo "ðŸ”¨ Compiling for ${{ matrix.board }}..."
          
          arduino-cli compile \
            --fqbn ${{ matrix.board }} \
            --output-dir build \
            --build-property "compiler.warning_level=all" \
            --warnings all \
            --verbose \
            ${{ env.SKETCH_NAME }}
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
          BOARD_NAME=$(echo "${{ matrix.board }}" | cut -d':' -f3)
          if [ -f "build/${{ env.SKETCH_NAME }}.bin" ]; then
            mv build/${{ env.SKETCH_NAME }}.bin build/firmware-${BOARD_NAME}.bin
            echo "âœ… Firmware built successfully: firmware-${BOARD_NAME}.bin"
          fi

      # ðŸ“Š Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Build information
        if: success()
        run: |
          echo "ðŸ“¦ Build completed successfully!"
          echo "ðŸ“ Generated files:"
          ls -lh build/
          
          if [ -f "build/firmware-"*.bin ]; then
            echo "ðŸ“ Firmware size:"
            du -h build/firmware-*.bin
          fi

      # ðŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ©
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: firmware-${{ matrix.board }}-${{ github.sha }}
          path: |
            build/*.bin
            build/*.elf
            build/*.map
          retention-days: 30
          if-no-files-found: error

      # ðŸ·ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø¥ØµØ¯Ø§Ø± ÙÙŠ GitHub Releases (Ù„Ù„Ù€ Tags ÙÙ‚Ø·)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.bin
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸš€ ESP32 Firmware Release
            
            **Board:** ${{ matrix.board }}
            **Commit:** ${{ github.sha }}
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            
            ### ðŸ“¥ Installation
            Flash using esptool:
            ```bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 firmware-esp32.bin
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ðŸ§¹ ØªÙ†Ø¸ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -rf build/*.elf build/*.map 2>/dev/null || true
